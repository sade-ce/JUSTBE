function onApiLoad(){gapi.load("auth",{callback:onAuthApiLoad}),gapi.load("picker",{callback:onPickerApiLoad})}function onAuthApiLoad(){window.gapi.auth.authorize({client_id:gdrive_clientId,scope:scope,immediate:!1},handleAuthResult)}function onPickerApiLoad(){pickerApiLoaded=!0}function handleAuthResult(e){e&&!e.error&&(oauthToken=e.access_token,oauthData=e,createPicker())}function createPicker(){if(pickerApiLoaded&&oauthToken){var e=new google.picker.DocsView(google.picker.ViewId.DOCS);e.setMode(google.picker.DocsViewMode.LIST),e.setIncludeFolders(!0),e.setOwnedByMe(!0);(new google.picker.PickerBuilder).addView(e).setOAuthToken(oauthToken).setDeveloperKey(gdrive_developerKey).setCallback(pickerCallback).build().setVisible(!0)}}function pickerCallback(e){if(e[google.picker.Response.ACTION]==google.picker.Action.PICKED){var t=e[google.picker.Response.DOCUMENTS][0],i={fileId:t[google.picker.Document.ID],fileName:t[google.picker.Document.NAME],token:oauthToken,mimeType:t[google.picker.Document.MIME_TYPE]};!0===qgGdrive.drive.checkUsesGdrive()&&qgGdrive.drive.setFile(i.fileName,i.fileId,i.mimeType,i.token);document.querySelector("#drive_picker > .btn-status").style.background="transparent url('"+static_server+"/images/status-ok.png') no-repeat";var r=document.getElementById("gdrive_input");if(r)return void r.setAttribute("value",JSON.stringify(i));var o=document.createElement("input");o.setAttribute("type","hidden"),o.setAttribute("id","gdrive_input"),o.setAttribute("name","gdrive_input"),o.setAttribute("value",JSON.stringify(i)),document.getElementById("forms").appendChild(o)}}!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","jquery-ui/ui/widget"],e):"object"==typeof exports?e(require("jquery"),require("./vendor/jquery.ui.widget")):e(window.jQuery)}(function(e){"use strict";function t(t){var i="dragover"===t;return function(r){r.dataTransfer=r.originalEvent&&r.originalEvent.dataTransfer;var o=r.dataTransfer;o&&-1!==e.inArray("Files",o.types)&&!1!==this._trigger(t,e.Event(t,{delegatedEvent:r}))&&(r.preventDefault(),i&&(o.dropEffect="copy"))}}e.support.fileInput=!(new RegExp("(Android (1\\.[0156]|2\\.[01]))|(Windows Phone (OS 7|8\\.0))|(XBLWP)|(ZuneWP)|(WPDesktop)|(w(eb)?OSBrowser)|(webOS)|(Kindle/(1\\.0|2\\.[05]|3\\.0))").test(window.navigator.userAgent)||e('<input type="file"/>').prop("disabled")),e.support.xhrFileUpload=!(!window.ProgressEvent||!window.FileReader),e.support.xhrFormDataFileUpload=!!window.FormData,e.support.blobSlice=window.Blob&&(Blob.prototype.slice||Blob.prototype.webkitSlice||Blob.prototype.mozSlice),e.widget("blueimp.fileupload",{options:{dropZone:e(document),pasteZone:undefined,fileInput:undefined,replaceFileInput:!0,paramName:undefined,singleFileUploads:!0,limitMultiFileUploads:undefined,limitMultiFileUploadSize:undefined,limitMultiFileUploadSizeOverhead:512,sequentialUploads:!1,limitConcurrentUploads:undefined,forceIframeTransport:!1,redirect:undefined,redirectParamName:undefined,postMessage:undefined,multipart:!0,maxChunkSize:undefined,uploadedBytes:undefined,recalculateProgress:!0,progressInterval:100,bitrateInterval:500,autoUpload:!0,messages:{uploadedBytes:"Uploaded bytes exceed file size"},i18n:function(t,i){return t=this.messages[t]||t.toString(),i&&e.each(i,function(e,i){t=t.replace("{"+e+"}",i)}),t},formData:function(e){return e.serializeArray()},add:function(t,i){if(t.isDefaultPrevented())return!1;(i.autoUpload||!1!==i.autoUpload&&e(this).fileupload("option","autoUpload"))&&i.process().done(function(){i.submit()})},processData:!1,contentType:!1,cache:!1,timeout:0},_specialOptions:["fileInput","dropZone","pasteZone","multipart","forceIframeTransport"],_blobSlice:e.support.blobSlice&&function(){return(this.slice||this.webkitSlice||this.mozSlice).apply(this,arguments)},_BitrateTimer:function(){this.timestamp=Date.now?Date.now():(new Date).getTime(),this.loaded=0,this.bitrate=0,this.getBitrate=function(e,t,i){var r=e-this.timestamp;return(!this.bitrate||!i||r>i)&&(this.bitrate=(t-this.loaded)*(1e3/r)*8,this.loaded=t,this.timestamp=e),this.bitrate}},_isXHRUpload:function(t){return!t.forceIframeTransport&&(!t.multipart&&e.support.xhrFileUpload||e.support.xhrFormDataFileUpload)},_getFormData:function(t){var i;return"function"===e.type(t.formData)?t.formData(t.form):e.isArray(t.formData)?t.formData:"object"===e.type(t.formData)?(i=[],e.each(t.formData,function(e,t){i.push({name:e,value:t})}),i):[]},_getTotal:function(t){var i=0;return e.each(t,function(e,t){i+=t.size||1}),i},_initProgressObject:function(t){var i={loaded:0,total:0,bitrate:0};t._progress?e.extend(t._progress,i):t._progress=i},_initResponseObject:function(e){var t;if(e._response)for(t in e._response)e._response.hasOwnProperty(t)&&delete e._response[t];else e._response={}},_onProgress:function(t,i){if(t.lengthComputable){var r,o=Date.now?Date.now():(new Date).getTime();if(i._time&&i.progressInterval&&o-i._time<i.progressInterval&&t.loaded!==t.total)return;i._time=o,r=Math.floor(t.loaded/t.total*(i.chunkSize||i._progress.total))+(i.uploadedBytes||0),this._progress.loaded+=r-i._progress.loaded,this._progress.bitrate=this._bitrateTimer.getBitrate(o,this._progress.loaded,i.bitrateInterval),i._progress.loaded=i.loaded=r,i._progress.bitrate=i.bitrate=i._bitrateTimer.getBitrate(o,r,i.bitrateInterval),this._trigger("progress",e.Event("progress",{delegatedEvent:t}),i),this._trigger("progressall",e.Event("progressall",{delegatedEvent:t}),this._progress)}},_initProgressListener:function(t){var i=this,r=t.xhr?t.xhr():e.ajaxSettings.xhr();r.upload&&(e(r.upload).bind("progress",function(e){var r=e.originalEvent;e.lengthComputable=r.lengthComputable,e.loaded=r.loaded,e.total=r.total,i._onProgress(e,t)}),t.xhr=function(){return r})},_isInstanceOf:function(e,t){return Object.prototype.toString.call(t)==="[object "+e+"]"},_initXHRData:function(t){var i,r=this,o=t.files[0],n=t.multipart||!e.support.xhrFileUpload,a="array"===e.type(t.paramName)?t.paramName[0]:t.paramName;t.headers=e.extend({},t.headers),t.contentRange&&(t.headers["Content-Range"]=t.contentRange),n&&!t.blob&&this._isInstanceOf("File",o)||(t.headers["Content-Disposition"]='attachment; filename="'+encodeURI(o.uploadName||o.name)+'"'),n?e.support.xhrFormDataFileUpload&&(t.postMessage?(i=this._getFormData(t),t.blob?i.push({name:a,value:t.blob}):e.each(t.files,function(r,o){i.push({name:"array"===e.type(t.paramName)&&t.paramName[r]||a,value:o})})):(r._isInstanceOf("FormData",t.formData)?i=t.formData:(i=new FormData,e.each(this._getFormData(t),function(e,t){i.append(t.name,t.value)})),t.blob?i.append(a,t.blob,o.uploadName||o.name):e.each(t.files,function(o,n){(r._isInstanceOf("File",n)||r._isInstanceOf("Blob",n))&&i.append("array"===e.type(t.paramName)&&t.paramName[o]||a,n,n.uploadName||n.name)})),t.data=i):(t.contentType=o.type||"application/octet-stream",t.data=t.blob||o),t.blob=null},_initIframeSettings:function(t){var i=e("<a></a>").prop("href",t.url).prop("host");t.dataType="iframe "+(t.dataType||""),t.formData=this._getFormData(t),t.redirect&&i&&i!==location.host&&t.formData.push({name:t.redirectParamName||"redirect",value:t.redirect})},_initDataSettings:function(e){this._isXHRUpload(e)?(this._chunkedUpload(e,!0)||(e.data||this._initXHRData(e),this._initProgressListener(e)),e.postMessage&&(e.dataType="postmessage "+(e.dataType||""))):this._initIframeSettings(e)},_getParamName:function(t){var i=e(t.fileInput),r=t.paramName;return r?e.isArray(r)||(r=[r]):(r=[],i.each(function(){for(var t=e(this),i=t.prop("name")||"files[]",o=(t.prop("files")||[1]).length;o;)r.push(i),o-=1}),r.length||(r=[i.prop("name")||"files[]"])),r},_initFormSettings:function(t){t.form&&t.form.length||(t.form=e(t.fileInput.prop("form")),t.form.length||(t.form=e(this.options.fileInput.prop("form")))),t.paramName=this._getParamName(t),t.url||(t.url=t.form.prop("action")||location.href),t.type=(t.type||"string"===e.type(t.form.prop("method"))&&t.form.prop("method")||"").toUpperCase(),"POST"!==t.type&&"PUT"!==t.type&&"PATCH"!==t.type&&(t.type="POST"),t.formAcceptCharset||(t.formAcceptCharset=t.form.attr("accept-charset"))},_getAJAXSettings:function(t){var i=e.extend({},this.options,t);return this._initFormSettings(i),this._initDataSettings(i),i},_getDeferredState:function(e){return e.state?e.state():e.isResolved()?"resolved":e.isRejected()?"rejected":"pending"},_enhancePromise:function(e){return e.success=e.done,e.error=e.fail,e.complete=e.always,e},_getXHRPromise:function(t,i,r){var o=e.Deferred(),n=o.promise();return i=i||this.options.context||n,!0===t?o.resolveWith(i,r):!1===t&&o.rejectWith(i,r),n.abort=o.promise,this._enhancePromise(n)},_addConvenienceMethods:function(t,i){var r=this,o=function(t){return e.Deferred().resolveWith(r,t).promise()};i.process=function(t,n){return(t||n)&&(i._processQueue=this._processQueue=(this._processQueue||o([this])).then(function(){return i.errorThrown?e.Deferred().rejectWith(r,[i]).promise():o(arguments)}).then(t,n)),this._processQueue||o([this])},i.submit=function(){return"pending"!==this.state()&&(i.jqXHR=this.jqXHR=!1!==r._trigger("submit",e.Event("submit",{delegatedEvent:t}),this)&&r._onSend(t,this)),this.jqXHR||r._getXHRPromise()},i.abort=function(){return this.jqXHR?this.jqXHR.abort():(this.errorThrown="abort",r._trigger("fail",null,this),r._getXHRPromise(!1))},i.state=function(){return this.jqXHR?r._getDeferredState(this.jqXHR):this._processQueue?r._getDeferredState(this._processQueue):void 0},i.processing=function(){return!this.jqXHR&&this._processQueue&&"pending"===r._getDeferredState(this._processQueue)},i.progress=function(){return this._progress},i.response=function(){return this._response}},_getUploadedBytes:function(e){var t=e.getResponseHeader("Range"),i=t&&t.split("-"),r=i&&i.length>1&&parseInt(i[1],10);return r&&r+1},_chunkedUpload:function(t,i){t.uploadedBytes=t.uploadedBytes||0;var r,o,n=this,a=t.files[0],s=a.size,l=t.uploadedBytes,d=t.maxChunkSize||s,p=this._blobSlice,u=e.Deferred(),c=u.promise();return!(!(this._isXHRUpload(t)&&p&&(l||("function"===e.type(d)?d(t):d)<s))||t.data)&&(!!i||(l>=s?(a.error=t.i18n("uploadedBytes"),this._getXHRPromise(!1,t.context,[null,"error",a.error])):(o=function(){var i=e.extend({},t),c=i._progress.loaded;i.blob=p.call(a,l,l+("function"===e.type(d)?d(i):d),a.type),i.chunkSize=i.blob.size,i.contentRange="bytes "+l+"-"+(l+i.chunkSize-1)+"/"+s,n._initXHRData(i),n._initProgressListener(i),r=(!1!==n._trigger("chunksend",null,i)&&e.ajax(i)||n._getXHRPromise(!1,i.context)).done(function(r,a,d){l=n._getUploadedBytes(d)||l+i.chunkSize,c+i.chunkSize-i._progress.loaded&&n._onProgress(e.Event("progress",{lengthComputable:!0,loaded:l-i.uploadedBytes,total:l-i.uploadedBytes}),i),t.uploadedBytes=i.uploadedBytes=l,i.result=r,i.textStatus=a,i.jqXHR=d,n._trigger("chunkdone",null,i),n._trigger("chunkalways",null,i),l<s?o():u.resolveWith(i.context,[r,a,d])}).fail(function(e,t,r){i.jqXHR=e,i.textStatus=t,i.errorThrown=r,n._trigger("chunkfail",null,i),n._trigger("chunkalways",null,i),u.rejectWith(i.context,[e,t,r])})},this._enhancePromise(c),c.abort=function(){return r.abort()},o(),c)))},_beforeSend:function(e,t){0===this._active&&(this._trigger("start"),this._bitrateTimer=new this._BitrateTimer,this._progress.loaded=this._progress.total=0,this._progress.bitrate=0),this._initResponseObject(t),this._initProgressObject(t),t._progress.loaded=t.loaded=t.uploadedBytes||0,t._progress.total=t.total=this._getTotal(t.files)||1,t._progress.bitrate=t.bitrate=0,this._active+=1,this._progress.loaded+=t.loaded,this._progress.total+=t.total},_onDone:function(t,i,r,o){var n=o._progress.total,a=o._response;o._progress.loaded<n&&this._onProgress(e.Event("progress",{lengthComputable:!0,loaded:n,total:n}),o),a.result=o.result=t,a.textStatus=o.textStatus=i,a.jqXHR=o.jqXHR=r,this._trigger("done",null,o)},_onFail:function(e,t,i,r){var o=r._response;r.recalculateProgress&&(this._progress.loaded-=r._progress.loaded,this._progress.total-=r._progress.total),o.jqXHR=r.jqXHR=e,o.textStatus=r.textStatus=t,o.errorThrown=r.errorThrown=i,this._trigger("fail",null,r)},_onAlways:function(e,t,i,r){this._trigger("always",null,r)},_onSend:function(t,i){i.submit||this._addConvenienceMethods(t,i);var r,o,n,a,s=this,l=s._getAJAXSettings(i),d=function(){return s._sending+=1,l._bitrateTimer=new s._BitrateTimer,r=r||((o||!1===s._trigger("send",e.Event("send",{delegatedEvent:t}),l))&&s._getXHRPromise(!1,l.context,o)||s._chunkedUpload(l)||e.ajax(l)).done(function(e,t,i){s._onDone(e,t,i,l)}).fail(function(e,t,i){s._onFail(e,t,i,l)}).always(function(e,t,i){if(s._onAlways(e,t,i,l),s._sending-=1,s._active-=1,l.limitConcurrentUploads&&l.limitConcurrentUploads>s._sending)for(var r=s._slots.shift();r;){if("pending"===s._getDeferredState(r)){r.resolve();break}r=s._slots.shift()}0===s._active&&s._trigger("stop")})};return this._beforeSend(t,l),this.options.sequentialUploads||this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending?(this.options.limitConcurrentUploads>1?(n=e.Deferred(),this._slots.push(n),a=n.then(d)):(this._sequence=this._sequence.then(d,d),a=this._sequence),a.abort=function(){return o=[undefined,"abort","abort"],r?r.abort():(n&&n.rejectWith(l.context,o),d())},this._enhancePromise(a)):d()},_onAdd:function(t,i){var r,o,n,a,s=this,l=!0,d=e.extend({},this.options,i),p=i.files,u=p.length,c=d.limitMultiFileUploads,g=d.limitMultiFileUploadSize,f=d.limitMultiFileUploadSizeOverhead,h=0,m=this._getParamName(d),v=0;if(!u)return!1;if(g&&p[0].size===undefined&&(g=undefined),(d.singleFileUploads||c||g)&&this._isXHRUpload(d))if(d.singleFileUploads||g||!c)if(!d.singleFileUploads&&g)for(n=[],r=[],a=0;a<u;a+=1)h+=p[a].size+f,(a+1===u||h+p[a+1].size+f>g||c&&a+1-v>=c)&&(n.push(p.slice(v,a+1)),o=m.slice(v,a+1),o.length||(o=m),r.push(o),v=a+1,h=0);else r=m;else for(n=[],r=[],a=0;a<u;a+=c)n.push(p.slice(a,a+c)),o=m.slice(a,a+c),o.length||(o=m),r.push(o);else n=[p],r=[m];return i.originalFiles=p,e.each(n||p,function(o,a){var d=e.extend({},i);return d.files=n?a:[a],d.paramName=r[o],s._initResponseObject(d),s._initProgressObject(d),s._addConvenienceMethods(t,d),l=s._trigger("add",e.Event("add",{delegatedEvent:t}),d)}),l},_replaceFileInput:function(t){var i=t.fileInput,r=i.clone(!0),o=i.is(document.activeElement);t.fileInputClone=r,e("<form></form>").append(r)[0].reset(),i.after(r).detach(),o&&r.focus(),e.cleanData(i.unbind("remove")),this.options.fileInput=this.options.fileInput.map(function(e,t){return t===i[0]?r[0]:t}),i[0]===this.element[0]&&(this.element=r)},_handleFileTreeEntry:function(t,i){var r,o=this,n=e.Deferred(),a=[],s=function(e){e&&!e.entry&&(e.entry=t),n.resolve([e])},l=function(e){o._handleFileTreeEntries(e,i+t.name+"/").done(function(e){n.resolve(e)}).fail(s)},d=function(){r.readEntries(function(e){e.length?(a=a.concat(e),d()):l(a)},s)};return i=i||"",t.isFile?t._file?(t._file.relativePath=i,n.resolve(t._file)):t.file(function(e){e.relativePath=i,n.resolve(e)},s):t.isDirectory?(r=t.createReader(),d()):n.resolve([]),n.promise()},_handleFileTreeEntries:function(t,i){var r=this;return e.when.apply(e,e.map(t,function(e){return r._handleFileTreeEntry(e,i)})).then(function(){return Array.prototype.concat.apply([],arguments)})},_getDroppedFiles:function(t){t=t||{};var i=t.items;return i&&i.length&&(i[0].webkitGetAsEntry||i[0].getAsEntry)?this._handleFileTreeEntries(e.map(i,function(e){var t;return e.webkitGetAsEntry?(t=e.webkitGetAsEntry(),t&&(t._file=e.getAsFile()),t):e.getAsEntry()})):e.Deferred().resolve(e.makeArray(t.files)).promise()},_getSingleFileInputFiles:function(t){t=e(t);var i,r,o=t.prop("webkitEntries")||t.prop("entries");if(o&&o.length)return this._handleFileTreeEntries(o);if(i=e.makeArray(t.prop("files")),i.length)i[0].name===undefined&&i[0].fileName&&e.each(i,function(e,t){t.name=t.fileName,t.size=t.fileSize});else{if(!(r=t.prop("value")))return e.Deferred().resolve([]).promise();i=[{name:r.replace(/^.*\\/,"")}]}return e.Deferred().resolve(i).promise()},_getFileInputFiles:function(t){return t instanceof e&&1!==t.length?e.when.apply(e,e.map(t,this._getSingleFileInputFiles)).then(function(){return Array.prototype.concat.apply([],arguments)}):this._getSingleFileInputFiles(t)},_onChange:function(t){var i=this,r={fileInput:e(t.target),form:e(t.target.form)};this._getFileInputFiles(r.fileInput).always(function(o){r.files=o,i.options.replaceFileInput&&i._replaceFileInput(r),!1!==i._trigger("change",e.Event("change",{delegatedEvent:t}),r)&&i._onAdd(t,r)})},_onPaste:function(t){var i=t.originalEvent&&t.originalEvent.clipboardData&&t.originalEvent.clipboardData.items,r={files:[]};i&&i.length&&(e.each(i,function(e,t){var i=t.getAsFile&&t.getAsFile();i&&r.files.push(i)}),!1!==this._trigger("paste",e.Event("paste",{delegatedEvent:t}),r)&&this._onAdd(t,r))},_onDrop:function(t){t.dataTransfer=t.originalEvent&&t.originalEvent.dataTransfer;var i=this,r=t.dataTransfer,o={};r&&r.files&&r.files.length&&(t.preventDefault(),this._getDroppedFiles(r).always(function(r){o.files=r,!1!==i._trigger("drop",e.Event("drop",{delegatedEvent:t}),o)&&i._onAdd(t,o)}))},_onDragOver:t("dragover"),_onDragEnter:t("dragenter"),_onDragLeave:t("dragleave"),_initEventHandlers:function(){this._isXHRUpload(this.options)&&(this._on(this.options.dropZone,{dragover:this._onDragOver,drop:this._onDrop,dragenter:this._onDragEnter,dragleave:this._onDragLeave}),this._on(this.options.pasteZone,{paste:this._onPaste})),e.support.fileInput&&this._on(this.options.fileInput,{change:this._onChange})},_destroyEventHandlers:function(){this._off(this.options.dropZone,"dragenter dragleave dragover drop"),this._off(this.options.pasteZone,"paste"),this._off(this.options.fileInput,"change")},_destroy:function(){this._destroyEventHandlers()},_setOption:function(t,i){var r=-1!==e.inArray(t,this._specialOptions);r&&this._destroyEventHandlers(),this._super(t,i),r&&(this._initSpecialOptions(),this._initEventHandlers())},_initSpecialOptions:function(){var t=this.options;t.fileInput===undefined?t.fileInput=this.element.is('input[type="file"]')?this.element:this.element.find('input[type="file"]'):t.fileInput instanceof e||(t.fileInput=e(t.fileInput)),t.dropZone instanceof e||(t.dropZone=e(t.dropZone)),t.pasteZone instanceof e||(t.pasteZone=e(t.pasteZone))},_getRegExp:function(e){var t=e.split("/"),i=t.pop();return t.shift(),new RegExp(t.join("/"),i)},_isRegExpOption:function(t,i){return"url"!==t&&"string"===e.type(i)&&/^\/.*\/[igm]{0,3}$/.test(i)},_initDataAttributes:function(){var t=this,i=this.options,r=this.element.data();e.each(this.element[0].attributes,function(e,o){var n,a=o.name.toLowerCase();/^data-/.test(a)&&(a=a.slice(5).replace(/-[a-z]/g,function(e){return e.charAt(1).toUpperCase()}),n=r[a],t._isRegExpOption(a,n)&&(n=t._getRegExp(n)),i[a]=n)})},_create:function(){this._initDataAttributes(),this._initSpecialOptions(),this._slots=[],this._sequence=this._getXHRPromise(!0),this._sending=this._active=0,this._initProgressObject(this),this._initEventHandlers()},active:function(){return this._active},progress:function(){return this._progress},add:function(t){var i=this;t&&!this.options.disabled&&(t.fileInput&&!t.files?this._getFileInputFiles(t.fileInput).always(function(e){t.files=e,i._onAdd(null,t)}):(t.files=e.makeArray(t.files),this._onAdd(null,t)))},send:function(t){if(t&&!this.options.disabled){if(t.fileInput&&!t.files){var i,r,o=this,n=e.Deferred(),a=n.promise();return a.abort=function(){return r=!0,i?i.abort():(n.reject(null,"abort","abort"),a)},this._getFileInputFiles(t.fileInput).always(function(e){if(!r){if(!e.length)return void n.reject();t.files=e,i=o._onSend(null,t),i.then(function(e,t,i){n.resolve(e,t,i)},function(e,t,i){n.reject(e,t,i)})}}),this._enhancePromise(a)}if(t.files=e.makeArray(t.files),t.files.length)return this._onSend(null,t)}return this._getXHRPromise(!1,t&&t.context)}})});var scope=["https://www.googleapis.com/auth/drive.readonly","https://www.googleapis.com/auth/drive.install"],pickerApiLoaded=!1,oauthToken,oauthData,qgValidate=function(){var e={},t={},i=function(e){t.capCors=e,l()},r=function(e,t){switch(e){case"image":$("#width").rules("add",{digits:!0,range:[1,65e3],messages:{digits:qgValidate.qgMessages.digits,range:qgValidate.qgMessages.image_width.range}}),$("#height").rules("add",{digits:!0,range:[1,65e3],messages:{digits:qgValidate.qgMessages.digits,range:qgValidate.qgMessages.image_height.range}});break;case"video":$("#width").rules("add",{digits:!0,range:[1,1e4],messages:{digits:qgValidate.qgMessages.digits,range:qgValidate.qgMessages.video_width.range}}),$("#height").rules("add",{digits:!0,range:[1,1e4],messages:{digits:qgValidate.qgMessages.digits,range:qgValidate.qgMessages.video_height.range}})}},o=function(){return!!$("#external_url").val()},n=function(){return!!$("#file").val()},a=function(){return!!document.getElementById("gdrive_input")},s=function(){return!!document.getElementById("hash_string")&&$("#hash_string").val().length>0},l=function(){$.validator.addMethod("allowExactlyOneUploadSource",function(e,i){if(!1===t.capCors)return!0;var r=o()+n()+a()+s();return r>1?this.optional(i)||!1:0!==r},function(e,t){return 0===o()+n()+a()+s()?qgValidate.qgMessages.noInputDefinedByUser:qgValidate.qgMessages.moreThanOneInputDefinedByUser}),$.validator.addMethod("custom_url",function(e,t){return this.optional(t)||/^(?=[^\s]{4,4000})[^\s]{1,256}\.[^\s]{2,4000}$/i.test(e)||0===e.indexOf("oc-source://")},"Please provide a valid URL."),jQuery.validator.addMethod("filename_length",function(e,t){return this.optional(t)||$("#file").val().length<=130},"Filename Too Long"),jQuery.validator.addMethod("filesize",function(e,t,i){return this.optional(t)||t.files[0].size<=i}),jQuery.validator.addMethod("filesizeZero",function(e,t){return this.optional(t)||t.files[0].size>0},"The file does not contain any data and therefore can't be converted"),jQuery.validator.addMethod("timestamp",function(e,t){return this.optional(t)||/^[0-9]{2}:[0-9]{2}:[0-9]{2}$/.test(e)},e.timestamp),jQuery.validator.addMethod("video_bitrate",function(e,t){return 0==$("#video_target_size").length||(this.optional(t)||!($("#video_target_size").val().length>0&&$("#video_quality").val().length>0))},e.bitrateFilesize)};return{init:i,initAdditionalRules:r,qgRules:{file:{allowExactlyOneUploadSource:!0,filename_length:!0},external_url:{allowExactlyOneUploadSource:!0,normalizer:function(e){return $.trim(e)},custom_url:!0,maxlength:2500},hash_string:{allowExactlyOneUploadSource:!0,maxlength:4096},dpi:{digits:!0,range:[10,1200]},audio_start:{timestamp:!0},audio_end:{timestamp:!0},border:{number:!0,range:[0,20]},video_quality:{video_bitrate:!0,number:!0,range:[5,1e5]},video_target_size:{video_bitrate:!0,number:!0,range:[.005,2e3]},rate:{number:!0,range:[1,120]},video_start:{timestamp:!0},video_end:{timestamp:!0},crop_top:{number:!0,range:[0,1e5]},crop_bottom:{number:!0,range:[0,1e5]},crop_left:{number:!0,range:[0,1e5]},crop_right:{number:!0,range:[0,1e5]},base_font_size:{number:!0,range:[6,22]},black_white_threshold:{number:!0,range:[0,100]}},qgMessages:e}}(),qgUpload=function(){var e={uploadUrl:null,uploadToken:null,uploadUUID:null,uploadForm:null},t=[],i={},r=function(r,s,l){var d=$.Deferred();return i.handleUpload=s,i.handleError=l,e.uploadForm=r,$(r).fileupload({url:e.uploadUrl,dataType:"json",maxChunkSize:n.getDynamicChunkSize,singleFileUploads:!0,autoUpload:!1,replaceFileInput:!1,maxRetries:50,dropZone:null,retryTimeout:500,retries:0,beforeSend:function(t,i){t.setRequestHeader("x-oc-token",e.uploadToken),t.setRequestHeader("X-Oc-Upload-Uuid",e.uploadUUID)}}).bind("fileuploadadd",function(t,r){qgUpload.uploadStart=function(t,o){e.uploadUrl=t,e.uploadToken=o,e.uploadUUID=i.handleUpload.createUUID(e.uploadToken),r.submit()}}).bind("fileuploaddone",function(e,r){i.handleUpload.uploadDone(r,t)}).bind("fileuploadfail",function(t,a){if(n.resetChunkSpeed(),"undefined"==typeof a.jqXHR.responseJSON)o(a,t);else if("Problem uploading file"===a.jqXHR.responseJSON.error)o(a,t);else{try{if("undefined"!=typeof $(r).find("input:file")[0].files[0])var s=$(r).find("input:file")[0].files[0];else var s={name:null,size:null,type:null}}catch(l){var s={name:null,size:null,type:null}}i.handleUpload.uploadError("qgHandle.qgUpload.singleFileUpload - fail with response",t,a,{token:e.uploadToken,server:e.uploadUrl,uuid:e.uploadUUID,file:{name:s.name,size:s.size,type:s.type},response:JSON.stringify(a.jqXHR.responseJSON)})}}).bind("fileuploadprogress",function(e,t){i.handleUpload.updateProgress(a.renderData(t))}).bind("fileuploadchunkdone",function(e,t){var i=$(this).data("blueimp-fileupload")||$(this).data("fileupload");n.increaseChunkSpeed(),i.options.retries>10&&(i.options.retries=10)}).bind("fileuploadchunkalways",function(i,r){var o={range:r.contentRange,loaded:r.loaded,uploadedBytes:r.uploadedBytes,textStatus:r.textStatus,url:r.url,uuid:e.uploadUUID};t.push(o)}),d.resolve(),d},o=function(r,o){var n=$(e.uploadForm).data("blueimp-fileupload")||$(e.uploadForm).data("fileupload"),s=function(){r.submit()};"abort"!==r.errorThrown&&r.uploadedBytes<r.files[0].size&&n.options.retries<n.options.maxRetries?(i.handleUpload.uploadError("qgHandle.qgUpload.singleFileUpload - chunk fail: retry",o,r,{token:e.uploadToken,uuid:e.uploadUUID,server:e.uploadUrl,bitrate:a.formatBitrate(r._bitrateTimer.bitrate),totalLoaded:a.formatFileSize(r._bitrateTimer.loaded),currentRetry:n.options.retries}),n.options.retries+=1,window.setTimeout(s,n.options.retries*n.options.retryTimeout)):(t=t.slice(-30),i.handleUpload.uploadError("qgHandle.qgUpload.singleFileUpload critical fail - retries exhausted",o,r,{token:e.uploadToken,uuid:e.uploadUUID,server:e.uploadUrl,chunkinfo:JSON.stringify(t)}),alert(qgValidate.qgMessages.networkErrorMessage))},n={baseChunkSize:1e6,minChunkSize:1e5,maxChunkSize:1e8,speedModifier:3,maxSpeedModifier:5,increaseChunkSpeed:function(){n.limitSpeed(++n.speedModifier)},resetChunkSpeed:function(){n.speedModifier=1},getDynamicChunkSize:function(e){var t=e.progress();if(0===t.loaded)return n.baseChunkSize;if(1===n.speedModifier)return n.minChunkSize;var i=parseInt(t.bitrate)*n.speedModifier;return n.limitChunk(i)},limitChunk:function(e){return Math.max(n.minChunkSize,Math.min(e,n.maxChunkSize))},limitSpeed:function(e){n.speedModifier=Math.max(1,Math.min(e,n.maxSpeedModifier))}},a={renderData:function(e){return{speed:this.formatBitrate(e.bitrate),size:this.formatFileSize(e.loaded)+" / "+this.formatFileSize(e.total),time:this.formatTime(8*(e.total-e.loaded)/e.bitrate),percentage:this.formatPercentage(e.loaded/e.total)}},formatBitrate:function(e){return"number"!=typeof e?"":e>=1e9?(e/1e9).toFixed(2)+" Gbit/s":e>=1e6?(e/1e6).toFixed(2)+" Mbit/s":e>=1e3?(e/1e3).toFixed(2)+" kbit/s":e.toFixed(2)+" bit/s"},formatFileSize:function(e){return"number"!=typeof e?"":e>=1e9?(e/1e9).toFixed(2)+" GB":e>=1e6?(e/1e6).toFixed(2)+" MB":(e/1e3).toFixed(2)+" KB"},formatTime:function(e){var t=new Date(1e3*e),i=Math.floor(e/86400);return(i=i?i+"d ":"")+("0"+t.getUTCHours()).slice(-2)+":"+("0"+t.getUTCMinutes()).slice(-2)+":"+("0"+t.getUTCSeconds()).slice(-2)},formatPercentage:function(e){return(100*e).toFixed(0)}};return{uploadSingleFile:r}}(),qgJob=function(){return{createJob:function(e,t){var i=$.Deferred(),r=$(t).serialize();return $.ajax({type:"POST",url:e,data:r,cache:!1,xhrFields:{withCredentials:!0}}).success(function(e){try{i.resolve(JSON.parse(e),r)}catch(t){i.resolve(e,r)}}).fail(function(e,t){i.reject(t,r)}),i}}}(),qgFileoptions=function(){return{getOptions:function(e,t){var i=$.Deferred();return $.ajax({type:"POST",url:e,data:{source_format:t},cache:!1,xhrFields:{withCredentials:!0}}).success(function(e){try{i.resolve(JSON.parse(e))}catch(t){i.resolve(e)}}).fail(function(e,t){i.reject(t)}),i}}}(),qgHandle=function(){var e={inputForm:null,fileForm:null,fileInput:null,requestDomain:null,resultBase:null,overuseUrl:null,filetoobigUrl:null,category:null,capCors:null,capTarget:null,capFileAPI:null,capBlob:null,uploadInfo:null,jobId:[],jobProcessing:!1,uploadToken:null,uploadUrl:null,qgJobData:null,maxRetriesJob:10,retryTimeoutJob:1e3,maxFileSize:0},t=function(t,r,n,a,l,d,u,c,g){d=void 0!==d?d:"singleFileUpload",e.maxFileSize=void 0!==g?g:104857600,e.inputForm=t,e.fileForm=r,e.fileInput=n,e.requestDomain=a,e.resultBase=l,e.overuseUrl=u,e.filetoobigUrl=c,o.checkCors(),o.checkTarget(),o.checkFileAPI(),o.checkBlob(),o.checkIfPresetPage(),o.checkIfAudioVbrPage(),p.setCategory(),p.beforeUnload(),!0===e.capCors&&!0===e.capTarget&&"singleFileUpload"===d&&s(e.fileForm),i()},i=function(){qgValidate.init(e.capCors);var t=$(e.inputForm).validate({ignoreTitle:!0,onkeyup:!1,onsubmit:!1,rules:qgValidate.qgRules,messages:qgValidate.qgMessages}),i=$(e.fileForm).validate({ignoreTitle:!0,onkeyup:!1,onsubmit:!1,rules:qgValidate.qgRules,messages:qgValidate.qgMessages});c(t,i),qgValidate.initAdditionalRules(e.category,e.inputForm),$(e.inputForm).submit(function(o){o.preventDefault();var a=i.form(),s=t.form();a&&s&&!0===r(i)&&(!0===e.capCors&&!0===e.capTarget&&!1===e.jobProcessing?(e.jobProcessing=!0,n()):!0!==e.jobProcessing&&$(e.inputForm).unbind("submit").submit())})},r=function(t){try{if(!0!==e.capFileAPI)return!0;var i=$(e.fileInput)[0].files[0];if("undefined"==typeof $(e.fileInput)[0].files[0])return!0;if(!(i.size>e.maxFileSize))return 0!==i.size||!0!==e.capBlob||(t.showErrors({file:"The file does not contain any data and therefore can't be converted"}),h.reportError("qgHandle.checkConstraints - filesizeZero",200),!1);h.reportError("qgHandle.checkConstraints - maxFileSize exceeded",500,{file_size:i.size,max_file_size:e.maxFileSize}),window.unsaved=!1,window.location.assign(e.filetoobigUrl+i.size)}catch(r){return!0}},o={checkCors:function(){"XMLHttpRequest"in window&&"withCredentials"in new XMLHttpRequest?e.capCors=!0:(h.reportError("qgHandle.checkCapabilities - noCors",200),e.capCors=!1)},checkTarget:function(){try{"string"==typeof $("#target").val()?e.capTarget=!0:(h.reportError("qgHandle.checkCapabilities - noTarget",200),e.capTarget=!1)}catch(t){h.reportError("qgHandle.checkCapabilities - noTarget",200),e.capTarget=!1}},checkFileAPI:function(){!0==!!(window.File&&window.FileReader&&window.FileList&&window.Blob)?e.capFileAPI=!0:(h.reportError("qgHandle.checkCapabilities - noFileAPI",200),e.capFileAPI=!1)},checkBlob:function(){try{return e.capBlob=!0,!!new Blob}catch(t){return h.reportError("qgHandle.checkCapabilities - noBlob",200),e.capBlob=!1,!1}},checkIfPresetPage:function(){$("#presetPage").length?p.handlePresetPage():$("#preset").length&&p.handlePresetOnNormalPage()},checkIfAudioVbrPage:function(){$("#audio_vbr").length&&p.handleAudioVbrPage()}},n=function(){f.showCreateJob(),qgJob.createJob(e.requestDomain,e.inputForm).done(function(t,i){if("string"==typeof t.job_id)if(e.jobId.push(t.job_id),h.reportError("qgHandle.qgJob.createJob success",200),!0===t.redirect)h.reportError("qgHandle.qgUpload.UploadSingleFile success with remote input",200),f.showResult(t.job_id);else if(window.unsaved=!0,e.uploadToken=t.token,e.uploadUrl=t.upload_url,$(e.fileForm).attr("action",e.uploadUrl),$("#token").val(e.uploadToken),$("#redirect_to").val(e.resultBase+t.job_id),$("#redirect_register").val(e.overuseUrl),!0===e.capBlob)try{f.showProgress(),qgUpload.uploadStart(e.uploadUrl,e.uploadToken)}catch(r){f.openForms();try{f.destroyFileupload()}catch(r){}l()}else l();else try{1==t.error.code?(h.reportError("qgHandle.qgJob.createJob fail - overuse",200),window.location=e.overuseUrl):3==t.error.code?(h.reportError("qgHandle.qgJob.createJob fail - forbidden Input ID",200),alert(t.error.text),f.resetPage()):a(t,i)}catch(r){a(t,i)}}).fail(function(t,i){try{1==t.error.code?(h.reportError("qgHandle.qgJob.createJob fail - overuse",200),window.location=e.overuseUrl):3==t.error.code?(h.reportError("qgHandle.qgJob.createJob fail - forbidden Input ID",200),alert(t.error.text),f.resetPage()):a(t,i)}catch(r){a(t,i)}})},a=function(t,i){try{var r=JSON.stringify(t),o=JSON.stringify(i)}catch(a){var r=JSON.stringify(a),o="empty"}
e.maxRetriesJob>0?(h.reportError("qgHandle.qgJob.createJob fail - retry",300,{server_response:r,form_info_data:o}),e.maxRetriesJob-=1,window.setTimeout(n,e.retryTimeoutJob)):(h.reportError("qgHandle.qgJob.createJob critical fail - retries exhausted",500,{server_response:r,form_info_data:o}),alert(qgValidate.qgMessages.networkErrorMessage),f.resetPage())},s=function(e){qgUpload.uploadSingleFile(e,d,h).done(function(e){f.showFileUpload()}).fail(function(e){h.reportError("qgHandle.qgUpload.uploadSingleFile fail on create",301)})},l=function(){f.openForms(),f.showUploading(),h.reportError("qgHandle.qgUpload.UploadSingleFile success with fallback upload",200),window.unsaved=!1,$(e.fileForm).unbind("submit").submit(),f.closeForms()},d={createUUID:function(e){try{return e+Math.floor(65536*(1+Math.random())).toString(6)}catch(t){return Math.floor(65536*(1+Math.random())).toString(6)}},updateProgress:function(e){$("#uploadfilesize").html(e.size),$("#uploadrate").html(e.speed),$("#uploadtimeleft").html(e.time),$(".progress-bar-v2").css("width",e.percentage+"%")},uploadDone:function(t,i){window.unsaved=!1,h.reportError("qgHandle.qgUpload.UploadSingleFile success",200);try{i=i.slice(-30),e.uploadInfo=JSON.stringify(i)}catch(r){e.uploadInfo="noInfo"}try{!0===t.jqXHR.responseJSON.completed?f.showResult(t.jqXHR.responseJSON.id.job):(h.reportError("qgHandle.qgUpload.UploadSingleFile critical fail - response from server broken",500,{upload_info:e.uploadInfo}),alert(qgValidate.qgMessages.networkErrorMessage),f.resetPage())}catch(r){try{h.reportError("qgHandle.qgUpload.UploadSingleFile critical fail - response from server broken",500,{upload_info:e.uploadInfo}),alert(qgValidate.qgMessages.networkErrorMessage),f.resetPage()}catch(r){h.reportError("qgHandle.qgUpload.UploadSingleFile critical fail - response from server broken",500),alert(qgValidate.qgMessages.networkErrorMessage),f.resetPage()}}},uploadError:function(t,i,r,o){window.unsaved=!1,"undefined"==typeof r.jqXHR.responseJSON?h.reportError("qgHandle.qgUpload.UploadSingleFile error with non-json response",500):"undefined"!=typeof r.jqXHR.responseJSON.error_code?(h.reportError("qgHandle.qgUpload.UploadSingleFile error with code",500,{error_code:r.jqXHR.responseJSON.error_code}),3===r.jqXHR.responseJSON.error_code&&(window.unsaved=!1,window.location.assign(e.filetoobigUrl+r.jqXHR.responseJSON.filesize_mb)),2===r.jqXHR.responseJSON.error_code&&(window.unsaved=!1,h.reportError("qgHandle.qgUpload.UploadSingleFile success with dl trust",200),f.showResult(e.jobId[0])),5===r.jqXHR.responseJSON.error_code&&(h.reportError("qgHandle.qgUpload.UploadSingleFile critical fail - Invalid File",200),alert(qgValidate.qgMessages.networkErrorMessage),f.resetPage())):(h.reportError("qgHandle.qgUpload.UploadSingleFile error json response without error_code",500),alert(qgValidate.qgMessages.networkErrorMessage),f.resetPage()),h.reportError(t,300,o)}},p={setCategory:function(){try{"string"==typeof $("#category").val()?e.category=$("#category").val():(h.reportError("qgHandle.setCategory - noCategory",200),e.category="NO_CATEGORY")}catch(t){h.reportError("qgHandle.checkCategory - noCategory",200),e.category="NO_CATEGORY"}},handlePresetPage:function(){f.showPresetJsOptions(),g();var e=$("#category").val();f.showOptionsForCategory(e),$("#category").change(function(){f.showOptionsForCategory(this.value)}),$("#target").change(function(){f.updatePresetOptions(this.value)});var t=u("selected_preset");null!==t&&$.each(presets_data,function(e,i){var r=!1;if($.each(i,function(e,i){if(t===e)return $("#target").val(i.target).trigger("change"),$("#preset").val(e),r=!0,!1}),!0===r)return!1})},handlePresetOnNormalPage:function(){$("#preset").find("option").not(":first").remove(),f.showJsPresets(),$("#preset").change(function(){""!==this.value?f.disableOptionsForPresetConversion():f.enableBlockedPresetOptions()})},handleAudioVbrPage:function(){$("#audio_vbr").change(function(){"0"!==this.value?f.hideCbrOptions():f.showCbrOptions()})},beforeUnload:function(){$(window).bind("beforeunload",function(){if(window.unsaved)return h.reportError("qgHandle.qgJob.Upload browser closed by user",200),"You have unsaved changes on this page. Do you want to leave this page and discard your changes or stay on this page?"})}},u=function(e){var t={};return window.location.href.replace(location.hash,"").replace(/[?&]+([^=&]+)=?([^&]*)?/gi,function(e,i,r){t[i]=r!==undefined?r:""}),e?t[e]?t[e]:null:t},c=function(e,t){$("#external_url").change(function(){t.form(),e.form()}),$("#file").change(function(){t.form(),e.form()}),$("#hash_string").change(function(){t.form(),e.form()})},g=function(){$.each(presets_data[$("#target").val()],function(e,t){return $("#category").val(t.category).trigger("change"),!1})},f={showFileUpload:function(){$(".jsenabled").show(),$(".has-js").show(),$(".main-input-form").show(),$("#cloud_convert").show()},showCreateJob:function(){$("#qg-submit").hide(),this.openForms(),$("#cloud_convert").find("a").css("pointer-events","none"),$("#cloud_convert").find("#drive_picker").css("pointer-events","none"),$("#oc-ajax-loader-bar-uploading").hide(),$("#oc-ajax-loader-bar").show()},showUploading:function(){$("#oc-ajax-loader-bar").hide(),$("#oc-ajax-loader-bar-uploading").show()},showProgress:function(){this.closeForms(),$("#oc-ajax-loader-bar").hide(),$("#ajax-loader-bar").hide(),$("#oc-upload-progress").show()},showResult:function(t){window.location=e.resultBase+t},resetPage:function(){window.unsaved=!1,e.jobProcessing=!1,$("#qg-submit").show(),this.openForms(),$("#oc-ajax-loader-bar").hide(),$("#oc-ajax-loader-bar-uploading").hide(),$("#oc-upload-progress").hide(),$(".progress-bar-v2").css("width","0%"),$("#cloud_convert").find("a").css("pointer-events","all"),$("#cloud_convert").find("#drive_picker").css("pointer-events","all")},destroyFileupload:function(e){$(e).fileupload("disable"),$(e).fileupload("destroy")},openForms:function(){$(e.inputForm+" input").not(".isDisabled").prop("disabled",!1),$(e.fileForm+" input").not(".isDisabled").prop("disabled",!1),$(e.inputForm+" select").not(".isDisabled").prop("disabled",!1)},closeForms:function(){$(e.inputForm+" input").prop("disabled",!0),$(e.fileForm+" input").prop("disabled",!0),$(e.inputForm+" select").prop("disabled",!0)},showOptionsForCategory:function(e){"audio"===e?($(".video_options").hide(),$(".video_options_input").prop("disabled",!0),$(".video_options_input").addClass("isDisabled"),$(".audio_options").show(),$(".audio_options_input").prop("disabled",!1),$(".audio_options_input").removeClass("isDisabled")):"video"===e?($(".video_options").show(),$(".video_options_input").prop("disabled",!1),$(".video_options_input").removeClass("isDisabled"),$(".audio_options").hide(),$(".audio_options_input").prop("disabled",!0),$(".audio_options_input").addClass("isDisabled")):($(".target_options").hide(),$(".audio_options_input").prop("disabled",!0),$(".audio_options_input").addClass("isDisabled"),$(".video_options_input").prop("disabled",!0),$(".video_options_input").addClass("isDisabled"))},updatePresetOptions:function(e){$("#preset").empty();var t=!1;$.each(presets_data[e],function(e,i){$("#preset").append($("<option></option>").attr("value",e).text(i.name)),t||($("#category").val(i.category).trigger("change"),t=!0)})},showPresetJsOptions:function(){$(".presetNonJsOptions").remove(),$(".presetJsOptions").show()},showCbrOptions:function(){$("#bitrate").show()},hideCbrOptions:function(){$("#bitrate").val(0),$("#bitrate").hide()},disableOptionsForPresetConversion:function(){$("#width").val(""),$("#width").prop("disabled",!0),$("#width").addClass("isDisabled"),$("#height").val(""),$("#height").prop("disabled",!0),$("#height").addClass("isDisabled"),$("#rate").val(""),$("#rate").prop("disabled",!0),$("#rate").addClass("isDisabled"),$("#video_codec").append('<option value="">from preset</option>'),$("#video_codec").val(""),$("#video_codec").prop("disabled",!0),$("#video_codec").addClass("isDisabled"),$("#audio_codec").append('<option value="">from preset</option>'),$("#audio_codec").val(""),$("#audio_codec").prop("disabled",!0),$("#audio_codec").addClass("isDisabled")},enableBlockedPresetOptions:function(){$("#width").prop("disabled",!1),$("#width").removeClass("isDisabled"),$("#height").prop("disabled",!1),$("#height").removeClass("isDisabled"),$("#rate").prop("disabled",!1),$("#rate").removeClass("isDisabled"),$("#video_codec").prop("disabled",!1),$("#video_codec").removeClass("isDisabled"),$("#video_codec option[value='']").remove(),$("#audio_codec").prop("disabled",!1),$("#audio_codec").removeClass("isDisabled"),$("#audio_codec option[value='']").remove()},showJsPresets:function(){$.each(all_presets_json,function(e,t){$("#preset").append('<option value="'+e+'">'+t.name+"</option>")})}},h={reportError:function(t,i,r){"object"==typeof ocErrLog&&(r||(r={}),e.jobId.length>0&&(r.job_id=JSON.stringify(e.jobId)),ocErrLog.logStatusFe(t,i,r))}};return{init:t}}(),qgHandleCloud=function(){return{init:function(e,t,i,r){switch(e){case"qgGdrive":qgGdrive.init(t,i,r)}}}}(),qgGdrive=function(){var e={usesGdrive:!1,requestDomainJob:"",requestDomainOptions:"",inputForm:"#gdriveform",jobId:[],driveData:null,driveScope:"https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/drive.install",driveClient:"",driveKey:"",driveDiscovery:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],driveFile:{},fallBack:!1},t={},i=function(t,i,n){e.usesGdrive=!0,e.driveClient=i,e.driveKey=n,""!==t&&(s.showProgress(),o.parseDriveData(t),r.loadAuth())},r={initClient:function(){window.gapi.client.init({discoveryDocs:e.driveDiscovery,clientId:e.driveClient,scope:e.driveScope}),qgGdrive.drive.onAuthApiLoad()},loadAuth:function(){gapiPromise.then(function(){gapi.load("client:auth",qgGdrive.drive.initClient)})},onAuthApiLoad:function(){window.gapi.auth.authorize({client_id:e.driveClient,scope:e.driveScope,prompt:"none",login_hint:e.driveData.userId},qgGdrive.drive.handleAuthResult)},onAuthApiLoadScope:function(){window.gapi.auth.authorize({client_id:e.driveClient,scope:e.driveScope,prompt:"consent",login_hint:e.driveData.userId},qgGdrive.drive.handleAuthResult)},handleAuthResult:function(t){t&&!t.error?(e.driveFile.token=t.access_token,"object"==typeof e.driveData.ids?r.getFileMetadata(e.driveData.ids[0]):r.getFileMetadata(e.driveData.exportIds[0])):n.renderConsent()},onDriveCallback:function(){},getFileMetadata:function(t){s.showProgress(),gapi.client.drive.files.get({fileId:t}).execute(function(i){404===i.code?!1===e.fallBack&&(e.fallBack=!0,r.onAuthApiLoadScope()):r.setFile(i.name,t,i.mimeType,e.driveFile.token)})},setFile:function(t,i,r,n){e.driveFile.token=n,e.driveFile.fileName=t,e.driveFile.fileId=i,e.driveFile.mimeType=r,o.processDriveFile()},checkUsesGdrive:function(){return e.usesGdrive}},o={parseDriveData:function(t){try{e.driveData=JSON.parse(t)}catch(i){}},processDriveFile:function(){if(e.driveFile.fileName.indexOf(".")>-1)var t=e.driveFile.fileName.substr(e.driveFile.fileName.lastIndexOf(".")+1);else var t=e.driveFile.mimeType;e.driveFile.url="?g_fileid="+e.driveFile.fileId+"&g_filename="+e.driveFile.fileName+"&g_token="+e.driveFile.token+"&g_mimetype="+e.driveFile.mimeType+"&g_sizebytes="+e.driveFile.sizeBytes,l.reportError("qgGdrive.processDrive.options extension",200,{extension:t}),qgFileoptions.getOptions(qgGdrive.qgEndpoint.requestDomainOptions,t).done(function(e){n.renderOptions(e)}).fail(function(e){alert(qgValidate.qgMessages.networkErrorMessage),s.resetPage()})}},n={renderConsent:function(){s.hideProgress(),$("#gdriveConsent").click(function(){r.onAuthApiLoadScope()}),$("#gdriveConsent-box").show(),$("#drive_picker").hide()},renderOptions:function(t){$("#gdrive_input").val(JSON.stringify(e.driveFile)),$("#g-filename").html(e.driveFile.fileName),$("#g-selected-file").show(),$("#gdrive-options").empty(),s.hideProgress(),$.each(t,function(t,i){var r="<h2>"+i.info.name+'</h2><div id="gcat-'+t+'"></div>';$("#gdrive-options").append(r),$.each(i.target,function(i,r){var o=$("#convert-tpl").clone();o.find(".submit_button_big").val(r.converter_name),o.find(".submit_button_big").attr("name",i),o.find(".submit_button_big").attr("data-category",r.category),o.find(".submit_button_big").attr("data-target",r.raw_method),o.find("a").attr("href",r.url+e.driveFile.url),o.appendTo("#gcat-"+t),o.show()})}),$(".submit_button_big").click(function(){$("#target").val($(this).attr("data-target")),$("#category").val($(this).attr("data-category")),n.createJob()})},createJob:function(){s.showUpload(),qgJob.createJob(qgGdrive.qgEndpoint.requestDomainJob,e.inputForm).done(function(t,i){if("string"==typeof t.job_id)e.jobId.push(t.job_id),l.reportError("qgGdrive.qgJob.createJob success",200),!0===t.redirect&&(l.reportError("qgGdrive.qgUpload.UploadSingleFile success with remote input",200),n.showResult(t.job_id));else try{1==t.error.code?(l.reportError("qgGdrive.qgJob.createJob fail - overuse",200),window.location=qgGdrive.qgEndpoint.overuseUrl):3==t.error.code?(l.reportError("qgGdrive.qgJob.createJob fail - "+t.error.text,200),alert(t.error.text),s.resetPage()):a(t,i)}catch(r){a(t,i)}}).fail(function(e,t){try{1==e.error.code?(l.reportError("qgGdrive.qgJob.createJob fail - overuse",200),window.location=qgGdrive.qgEndpoint.overuseUrl):3==e.error.code?(l.reportError("qgGdrive.qgJob.createJob fail - "+e.error.text,200),alert(e.error.text),s.resetPage()):a(e,t)}catch(i){a(e,t)}})},showResult:function(e){window.location=qgGdrive.qgEndpoint.requestDomainResult+e}},a=function(t,i){try{var r=JSON.stringify(t),o=JSON.stringify(i)}catch(n){var r=JSON.stringify(n),o="empty"}e.maxRetriesJob>0?(l.reportError("qgGdrive.qgJob.createJob fail - retry",300,{server_response:r,form_info_data:o}),e.maxRetriesJob-=1,window.setTimeout(createJob,e.retryTimeoutJob)):(l.reportError("qgGdrive.qgJob.createJob critical fail - retries exhausted",500,{server_response:r,form_info_data:o}),alert(qgValidate.qgMessages.networkErrorMessage),s.resetPage())},s={showProgress:function(){$("#gdriveConsent-box").hide(),$("#drive_picker").hide(),$("#oc-ajax-loader-bar").show()},hideProgress:function(){$("#gdriveConsent-box").hide(),$("#drive_picker").show(),$("#oc-ajax-loader-bar").hide()},showUpload:function(){$("#drive_picker").css("pointer-events","none"),$("#drive_picker").css("pointer-events","none"),$("#gdrive-options").hide(),$("#oc-ajax-loader-bar-uploading").show()},hideUpload:function(){$("#drive_picker").css("pointer-events","all"),$("#drive_picker").css("pointer-events","all"),$("#gdrive-options").show(),$("#oc-ajax-loader-bar-uploading").hide()},resetPage:function(){s.hideProgress(),s.hideUpload()}},l={reportError:function(t,i,r){"object"==typeof ocErrLog&&(r||(r={}),e.jobId.length>0&&(r.job_id=JSON.stringify(e.jobId)),ocErrLog.logStatusFe(t,i,r))}};return{init:i,qgEndpoint:t,drive:r}}();